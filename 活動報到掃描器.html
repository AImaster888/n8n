<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動報到系統 - QR Code 掃描</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
        }
        
        #reader {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid #667eea;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #startBtn {
            background: #667eea;
            color: white;
        }
        
        #startBtn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        #stopBtn {
            background: #dc3545;
            color: white;
            display: none;
        }
        
        #stopBtn:hover {
            background: #c82333;
        }

        /* === 手動輸入的 CSS 樣式 === */
        .manual-entry {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        #manualInput {
            flex-grow: 1;
            padding: 15px;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid #ddd;
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
        }

        #manualBtn {
            flex-shrink: 0;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: #28a745;
            color: white;
        }
        #manualBtn:hover {
            background: #218838;
        }
        /* === 樣式結束 === */

        .result {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.5s;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result.success {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        .result.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        
        .result.duplicate {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .result-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .result.success .result-title {
            color: #155724;
        }
        
        .result.error .result-title {
            color: #721c24;
        }
        
        .result.duplicate .result-title {
            color: #856404;
        }
        
        .result-detail {
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result.success .result-detail {
            color: #155724;
        }
        
        .result.error .result-detail {
            color: #721c24;
        }
        
        .result.duplicate .result-detail {
            color: #856404;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎫 活動報到系統</h1>
            <p class="subtitle">請掃描參加者的 QR Code</p>
        </div>
        
        <div id="reader"></div>
        
        <div class="controls">
            <button id="startBtn" onclick="startScanning()">📷 開始掃描</button>
            <button id="stopBtn" onclick="stopScanning()">⏹️ 停止掃描</button>
        </div>

        <div class="manual-entry">
            <input type="text" id="manualInput" placeholder="請輸入報名編號">
            <button id="manualBtn" onclick="manualCheckIn()">手動報到</button>
        </div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>處理中，請稍候...</p>
        </div>
        
        <div id="result" class="result"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="successCount">0</div>
                <div class="stat-label">成功報到</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">失敗次數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="duplicateCount">0</div>
                <div class="stat-label">重複報到</div>
            </div>
        </div>
    </div>

    <script>
        // ⚙️ 設定區 - 請修改這裡
        const N8N_WEBHOOK_URL = 'https://yuyu1017.app.n8n.cloud/webhook/qr-checkin';
        
        let html5QrCode;
        let isScanning = false;
        let stats = {
            success: 0,
            error: 0,
            duplicate: 0
        };

        function startScanning() {
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            ).then(() => {
                isScanning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
            }).catch(err => {
                showResult('error', '無法開啟相機', '請確認已授權相機權限');
                console.error(err);
            });
        }

        function stopScanning() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                }).catch(err => {
                    console.error(err);
                });
            }
        }

        async function onScanSuccess(decodedText) {
            // 暫停掃描，避免重複
            if (html5QrCode && isScanning) {
                await html5QrCode.pause();
            }

            let qrData;
            try {
                // 解析 QR Code 資料
                qrData = JSON.parse(decodedText);
            } catch {
                // 如果不是 JSON，假設是報名編號
                qrData = { 報名編號: decodedText };
            }

            // 呼叫共用的報到處理函數
            await processCheckIn(qrData);

            // 3 秒後自動繼續掃描
            setTimeout(() => {
                if (html5QrCode && isScanning) {
                    html5QrCode.resume();
                }
            }, 3000);
        }

        // === 手動報到函數 ===
        async function manualCheckIn() {
            const inputValue = document.getElementById('manualInput').value;

            if (!inputValue || inputValue.trim() === '') {
                showResult('error', '輸入錯誤', '請輸入報名編號');
                playSound('error');
                return;
            }

            // 手動輸入的資料
            const postData = { 報名編號: inputValue.trim() };
            
            // 呼叫共用的報到處理函數
            await processCheckIn(postData);

            // 手動報到不需要重新啟動掃描
        }
        // === 新增結束 ===


        // === 共用處理函數 ===
        async function processCheckIn(postData) {
            // 顯示載入動畫
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            try {
                console.log('正在發送資料:', postData);
                console.log('目標 URL:', N8N_WEBHOOK_URL);
                
                // 發送到 n8n
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                const result = await response.json();
                
                console.log('===== 收到完整回應 =====');
                console.log('完整 result 物件:', result);
                console.log('result.報到編號:', result.報到編號);
                console.log('result.報名編號:', result.報名編號);
                console.log('result.姓名:', result.姓名);
                console.log('result.單位:', result.單位);
                console.log('result.報到時間:', result.報到時間);
                console.log('========================');

                // 隱藏載入動畫
                document.getElementById('loading').style.display = 'none';

                // 顯示結果
                if (result.status === 'success') {
                    stats.success++;
                    showResult(
                        'success',
                        '✅ 報到成功！',
                        `編號：${result.報到編號 || result.報名編號 || 'N/A'}\n` +
                        `姓名：${result.姓名 || '未提供'}\n` +
                        `單位：${result.單位 || '未提供'}\n` +
                        `時間：${result.報到時間 || new Date().toLocaleString('zh-TW')}`
                    );
                    playSound('success');
                } else if (result.status === 'duplicate') {
                    stats.duplicate++;
                    showResult(
                        'duplicate',
                        '⚠️ 重複報到',
                        `編號：${result.報到編號 || result.報名編號 || 'N/A'}\n` +
                        `姓名：${result.姓名 || '未提供'}\n` +
                        `單位：${result.單位 || '未提供'}\n` +
                        `上次報到：${result.報到時間 || '未記錄'}`
                    );
                    playSound('duplicate');
                } else {
                    stats.error++;
                    showResult(
                        'error',
                        '❌ 報到失敗',
                        result.message || '查無此報名資料，請確認資料是否正確'
                    );
                    playSound('error');
                }

                updateStats();

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                stats.error++;
                showResult('error', '❌ 系統錯誤', `無法連線到伺服器\n${error.message}`);
                updateStats();
                playSound('error');
Error
            }
        }
        // === 新增結束 ===


        function onScanError(errorMessage) {
            // 掃描錯誤（一般可忽略）
        }

        function showResult(type, title, detail) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <div class="result-title">${title}</div>
                <div class="result-detail">${detail.replace(/\n/g, '<br>')}</div>
            `;
            resultDiv.style.display = 'block';
        }

        function updateStats() {
            document.getElementById('successCount').textContent = stats.success;
            document.getElementById('errorCount').textContent = stats.error;
            document.getElementById('duplicateCount').textContent = stats.duplicate;
        }

        function playSound(type) {
            // 播放提示音（需要瀏覽器支援）
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'success') {
                oscillator.frequency.value = 800;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            } else if (type === 'duplicate') {
                oscillator.frequency.value = 600;
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            } else {
                oscillator.frequency.value = 400;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            }

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // 頁面關閉時停止掃描
        window.addEventListener('beforeunload', () => {
            if (html5QrCode && isScanning) {
                html5QrCode.stop();
            }
        });
    </script>
</body>
</html>